#include "sdk_ntag.h"
#include "tracedef.h"
#include <stdio.h>
#include "pub/taskdef.h"
#include "libapi_xpos/inc/libapi_system.h"
#include "lvgl/lvgl.h"
#include "pub/qrencode/QrEncode.h"
#include "page_main.h"
#include "libapi_xpos/inc/mfsdk_sys.h"
#include "./pages/page_qr.h"
#include "./pages/pages.h"
#include "./page_pub.h"


lv_obj_t* page_ntag = NULL;
static char ntag_url[256] = {0};
static int ntag_ret = 0;
static unsigned char CARD_UID_INFO[25] = 
{
	0x44,0x00,					//SENS_RES(2 bytes)
	0x01,0x02,0x03,				//NFCID1(  bytes)
	0x00,						//SEL_RES(1 byte)
	0x01,0xFE,					//polling response 
	0xF0,0xF1,0xF2,0xF3,0xF4,0xF5,	//NFCID2(6 bytes)
	0x80,0x81,0x82,0x83,0x84,0x85,0x86,0x87, //pad (8 bytes)
	0xAA,0xBB, //system code (2 bytes)
	0xFE //NFCID3 (1 byte)
};


#define Block_Capacity 231

// NTAG216
unsigned char Ntag_Block[Block_Capacity][4]= 
{
	{0x04,0xDF,0x73,0x20}, 
	{0x2A,0x5B,0x49,0x80}, 
	{0xB8,0x48,0x00,0x00},
	{0xE1,0x10,0x6D,0x00},
	{0x03,0x0E, 0xD1,0x01},
	{0x0A,0x55,0x01,0x62},
	{0x61,0x69,0x64,0x75},
	{0x2E,0x63,0x6F,0x6D},
	{0xFE,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0x00},
	{0x00,0x00,0x00,0xBD},
	{0x04,0x00,0x00,0xFF},
	{0x00,0x05,0x00,0x00},
	{0xFF,0xFF,0xFF,0xFF},
	{0x00,0x00,0x00,0x00}
};

void set_ntag_block(unsigned char *buff, int length)
{
	int i = 0;

	APP_TRACE_BUFF_TIP(buff, length, "NDEF MESSAGE");

	if (length > 0)
	{
		Ntag_Block[4][1] = length;
		Ntag_Block[4][2] = buff[0];
		Ntag_Block[4][3] = buff[1];
		for (i=0; i<length-2; i++)
		{
			Ntag_Block[i/4+5][i%4] = buff[i+2];
		}
		Ntag_Block[i/4+5][i%4] = 0xFE;
	}
	APP_TRACE_BUFF_TIP(Ntag_Block, 60, "NTAG BLOCK");
}

char get_url_type(char * url, pload_data *pload)
{
	if (strstr(url, "http://") != NULL)
	{
		if (strstr(url, "www.") != NULL)
		{
			pload->len = strlen(url) - 11;
			pload->pyload = url + 11;
			return URI_ID_0x01;
		}
		else
		{
			pload->len = strlen(url) - 7;
			pload->pyload = url + 7;
			return URI_ID_0x03;
		}
	}
	else if (strstr(url, "https://") != NULL)
	{
		if (strstr(url, "www.") != NULL)
		{
			pload->len = strlen(url) - 12;
			pload->pyload = url + 12;
			return URI_ID_0x02;
		}
		else
		{
			pload->len = strlen(url) - 8;
			pload->pyload = url + 8;
			return URI_ID_0x04;
		}
	}
	return URI_ID_0x00;
}

void set_ntag_url(char *url)
{
	char ndefMessage[256] = {0};
	pload_data payload = {0};
	char type;
	int len;

	ndefMessage[0] = 0xD1;
	ndefMessage[1] = 0x01;
	ndefMessage[3] = 0x55;
	type = get_url_type(url, &payload);
	ndefMessage[4] = type;
	len = payload.len + 1;
	APP_TRACE("%d", len);
	ndefMessage[2] = len;
	memcpy(&ndefMessage[5], payload.pyload, payload.len);

	set_ntag_block((u8*)ndefMessage, strlen(ndefMessage));
}

void ntag_config()
{
//    Sys_rfid_emulate_config(CARD_UID_INFO, sizeof(CARD_UID_INFO), Ntag_Block, Block_Capacity);
	MfSdkSysRfidEmulateConfig(CARD_UID_INFO, sizeof(CARD_UID_INFO), Ntag_Block, Block_Capacity);
}

#define _APP_TASK_SIZE		4096
#define _NTAG_TASK_PRIO		(0 + 4)
static  unsigned int  pTaskStk[_APP_TASK_SIZE];

static void ntag_task(void* p)
{
	unsigned int tick1 = MfSdkSysTimerOpen(3*1000);
	unsigned int count = 0;
	APP_TRACE("[%s][%d][begin]", __FUNCTION__, __LINE__);
//	Sys_rfid_emulate_init();
	MfSdkSysRfidEmulateInit();

	if(NULL!=ntag_url) set_ntag_url(ntag_url);

	ntag_config();
	while (1)
	{
//		Sys_rfid_emulate_process();
		MfSdkSysRfidEmulateProcess();
		if (MfSdkSysTimerCheck(tick1)==0)
		{
			APP_TRACE("[%s][%d][seconds:%d]", __FUNCTION__, __LINE__, count++);
			tick1 = MfSdkSysTimerOpen(3 * 1000);
			MfSdkSysSleep(500);
		}
		if (ntag_ret != 999) {
			break;
		}
	}
//	Sys_rfid_emulate_deinit();
	MfSdkSysRfidEmulateDeinit();
	APP_TRACE("[%s][%d][end]", __FUNCTION__, __LINE__);
//	OSTaskDel(_NTAG_TASK_PRIO);
	MfSdkSysTaskDel(_NTAG_TASK_PRIO);
}

static void _card_close_page(int ret)
{
	if (page_ntag != NULL)
	{
		lv_obj_del(page_ntag);
		page_ntag = NULL;
		//if (m_page_close_page_func != 0) m_page_close_page_func(ret, NULL);
	}
}

void sdk_ntag_test(void)
{		
	ntag_ret = 999;
	MfSdkSysTaskCreate(ntag_task, _NTAG_TASK_PRIO, (s8*)&(pTaskStk[0]), _APP_TASK_SIZE);

}
static void _card_event_cb(lv_obj_t* obj, lv_event_t e)
{
	uint32_t key;

	if (e == LV_EVENT_KEY) {
		key = page_get_key(0);

		APP_TRACE("[%s][%d][key_cb:%d]", __FUNCTION__, __LINE__, key);
		//if (key == MF_LV_KEY_DOWN_SHORT_PRESS) {
			ntag_ret = 0;
			_card_close_page(0);
		//}
	}
}
lv_obj_t* NTAG_Page(char *url)
{

	page_ntag = page_create_win(get_mainpage(), _card_event_cb);

	//ntag_url = NULL;
	lv_obj_t* lab_title = lv_label_create(page_ntag, NULL);
	lv_obj_clean_style_list(lab_title, LV_LABEL_PART_MAIN);
	//lv_obj_add_style(lab_tip, LV_LABEL_PART_MAIN, &style_lab_time);
	lv_label_set_long_mode(lab_title, LV_LABEL_LONG_EXPAND);
	lv_label_set_text(lab_title, "NTAG TEST");
	lv_obj_align(lab_title, NULL, LV_ALIGN_IN_TOP_MID, 0, 0);

	if (NULL != url) {
		//ntag_url = url;
		memset(ntag_url, 0, sizeof(ntag_url));
		memcpy(ntag_url, url, strlen(url));
		lv_obj_t* lab_url = lv_label_create(page_ntag, lab_title);
		lv_label_set_text(lab_title, ntag_url);
		lv_obj_align(lab_title, lab_url, LV_ALIGN_OUT_BOTTOM_LEFT, 0, 0);
	}


	lv_obj_set_event_cb(page_ntag, _card_event_cb);

	sdk_ntag_test();

	return page_ntag;
}

void NTAG_QrPage(char *url)
{	
	if (NULL != url)
	{		
		memset(ntag_url, 0, sizeof(ntag_url));
		memcpy(ntag_url, url, strlen(url));
		close_qrcode_page(0);
		page_show_qrcode(get_mainpage(), NULL, "NTAG", "Please Scan", ntag_url, 0);

		sdk_ntag_test();
	}
}
